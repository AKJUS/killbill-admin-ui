<% # Unclear why this url/method hack is needed %>
<%= form_for @allowed_user, :url => @allowed_user.persisted? ? admin_allowed_user_path(@allowed_user.id) : admin_allowed_users_path, :method => @allowed_user.persisted? ? :put : :post, :html => {:class => 'form-horizontal'} do |f| %>
    <input type="hidden" id="jdbcManaged" value="<%= @is_jdbc_managed %>" />
    <div class='form-group'>
      <div class="col-sm-offset-2 col-sm-9">
        <div class="checkbox">
          <%= label_tag :is_managed_externally do %>
              <%= f.check_box :is_managed_externally, { :disabled => !@allowed_user.id.blank? }, true, false %>Managed externally (LDAP, Okta, etc.)?
          <% end %>
        </div>
      </div>
    </div>
    <div class="form-group">
      <%= f.label :kb_username, 'Name', :class => 'col-sm-2 control-label' %>
      <div class="col-sm-10">
        <%= f.text_field :kb_username, :class => 'form-control', :required => true, :disabled => @allowed_user.persisted?, :readonly => @allowed_user.persisted? %>
      </div>
    </div>
    <div class="form-group">
      <%= f.label_tag :password, 'Password', :class => 'col-sm-2 control-label' %>
      <div class="col-sm-10">
        <%= f.password_field_tag :password, '', :class => 'form-control' %>
      </div>
    </div>
    <div class="form-group">
      <%= f.label :description, 'Description', :class => 'col-sm-2 control-label' %>
      <div class="col-sm-10">
        <%= f.text_field :description, :class => 'form-control' %>
      </div>
    </div>
    <div class="form-group">
      <%= label_tag :roles, 'Roles', :class => 'col-sm-2 control-label' %>
      <div class="col-sm-10">
        <%= text_field_tag :roles, @roles.join(','), :class => 'form-control' %>
        <p class="help-block">Comma separated, e.g. customer_support,finance.</p>
        <p class="help-block">Create a new role <%= link_to 'here', new_role_definition_path %>.</p>
      </div>
    </div>
    <div class="form-group">
      <div class="col-sm-offset-2 col-sm-10">
        <%= f.submit 'Save', :class => 'btn btn-default' %>
      </div>
    </div>
<% end %>

<!-- is the user been edited? -->
<% if @allowed_user.persisted? %>
  <div class="footer-notice managed-externally-notice">
    <div class="modal-footer">
      <div class="alert alert-warning">
        <strong>Notice</strong>
        <p id="noticeMessage">This user is managed externally (LDAP, Okta, etc.) or via Shiro configuration file.</p>
      </div>
    </div>
  </div>
<% end %>

<%= javascript_tag do %>
    $(document).ready(function() {

        $('#allowed_user_is_managed_externally').change(function() {
            is_jdbc_managed();
        });

        function is_jdbc_managed() {
            var isJdbcManaged = isBlank($('#jdbcManaged').val()) || $('#jdbcManaged').val() == 'true';

            if ($('#allowed_user_is_managed_externally').is(":checked") || !isJdbcManaged) {
                $('#password').attr('disabled', true);
                $('#roles').attr('disabled', true);
                $('.managed-externally-notice').show();
            }
            else {
                $('#password').attr('disabled', false);
                $('#roles').attr('disabled', false);
                $('.managed-externally-notice').hide();
            }
        }

        is_jdbc_managed();
    });
<% end %>
